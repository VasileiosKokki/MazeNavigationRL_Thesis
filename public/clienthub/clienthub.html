<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Start</title>
</head>
<body>
    <h1>Welcome to the Game</h1>
    <form id="gameForm">
        <label for="playerName">Enter your name:</label>
        <input type="text" id="playerName" required><br><br>
        <label for="serverSelect">Select a server:</label>
        <select id="serverSelect" required>
        </select><br><br>

        <button id="playButton">Play</button>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script type="module">




        // Shared variables
        import { executeWithOrder } from "../clienthub/functions.js";

        let playerName;
        let serverSelect;
        let buttonPressed;
        let serverData;
        let port;


        
        executeWithOrder(serverData).then(resolvedData => {
            serverData = resolvedData;
        });
        const interval1 = setInterval(() => {
            executeWithOrder(serverData).then(resolvedData => {
                serverData = resolvedData;
            });
        }, 2000);

        


        document.getElementById("playButton").addEventListener("click", async (event)=>{
            event.preventDefault(); // Prevent the form from submitting
            playerName = document.getElementById("playerName").value;
            serverSelect = document.getElementById("serverSelect").value;
            buttonPressed = true;


            if (serverData && serverData.length > 0) {
                const targetServer = serverData.find((server) => server.name === serverSelect);
                if (targetServer != undefined) {
                    port = JSON.stringify(targetServer.port);
                    console.log(port);
                }



                const url = `/redirect?serverSelect=${serverSelect}`;
                const result = await fetch(url, {
                    method: 'GET',
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                try {
                    const receivedText = await result.text();
                    if (result.ok) {

                        const tempElement = document.createElement('div');
                        tempElement.innerHTML = receivedText;

                        window.port = port;
                        window.playerName = playerName;

                        clearInterval(interval1);
                        // Insert the modified content into the document
                        document.open();
                        document.write(tempElement.innerHTML);
                        document.close();
                    } else {
                        throw new Error(receivedText);
                    }
                } catch (error) {
                    alert(error.message);
                }
            }
        });




    </script>
</body>
</html>